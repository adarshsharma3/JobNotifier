name: Superset Notifier

on:
  schedule:
    - cron: "0 */4 * * *"      # every¬†4¬†hours
  workflow_dispatch:            # manual trigger

jobs:
  run-notifier:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£  Check out repository
    - name: üì• Checkout repository
      uses: actions/checkout@v3

    # 2Ô∏è‚É£  Set up Python
    - name: üêç Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # 3Ô∏è‚É£  Install Python dependencies
    - name: üì¶ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r Requirements.txt

    # 4Ô∏è‚É£  Install Chrome + ChromeDriver
    - name: üåê Install Chrome & ChromeDriver
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip google-chrome-stable
        CHROME_MAJOR=$(google-chrome --version | grep -oP '([0-9]+)\.' | head -1 | tr -d '.')
        DRIVER_VERSION=$(wget -qO- "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_${CHROME_MAJOR}")
        wget -q "https://chromedriver.storage.googleapis.com/${DRIVER_VERSION}/chromedriver_linux64.zip"
        unzip chromedriver_linux64.zip
        sudo mv chromedriver /usr/local/bin/chromedriver
        sudo chmod +x /usr/local/bin/chromedriver

    # 5Ô∏è‚É£  Restore jobs_seen.json from cache (if it exists)
    - name: üíæ Restore jobs_seen.json cache
      id: cache-jobs
      uses: actions/cache@v3
      with:
        path: jobs_seen.json
        key: jobs-seen-cache          # constant key ‚áí same file reused every run
        restore-keys: jobs-seen-cache

    # 6Ô∏è‚É£  Run your notifier script
    - name: üöÄ Run notifier script
      env:
        SUP_USER: ${{ secrets.SUP_USER }}
        SUP_PASS: ${{ secrets.SUP_PASS }}
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: python main.py

    # 7Ô∏è‚É£  Save the updated jobs_seen.json back into the cache
    - name: üíΩ Save updated jobs_seen.json
      if: steps.cache-jobs.outputs.cache-hit != 'true'   # save only if cache key was a miss
      uses: actions/cache/save@v3
      with:
        path: jobs_seen.json
        key: jobs-seen-cache
